<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>资源加载中</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: #f8fafc;
      font-family: system-ui, sans-serif;
    }
    .container {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      width: 90%;
      max-width: 400px;
    }
    .loader {
      width: 48px;
      height: 48px;
      border: 5px solid #e2e8f0;
      border-bottom-color: #165DFF;
      border-radius: 50%;
      animation: rotation 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes rotation {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .wechat-tip {
      background: #fef3c7;
      border-left: 4px solid #f59e0b;
      padding: 10px;
      border-radius: 4px;
      margin-top: 15px;
      text-align: left;
      font-size: 12px;
      color: #78350f;
      display: none;
    }
    .expire-tip {
      background: #fee2e2;
      border-left: 4px solid #ef4444;
      padding: 10px;
      border-radius: 4px;
      margin-top: 15px;
      text-align: left;
      font-size: 12px;
      color: #991b1b;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="loader"></div>
    <h2 class="text-xl font-semibold text-gray-800 mb-2" id="loadTitle">资源加载中</h2>
    <p class="text-gray-600 mb-6 text-sm" id="loadDesc">正在验证资源安全性，请稍候...</p>
    <div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
      <div id="progress" class="h-full bg-blue-600 w-0 transition-all duration-1500"></div>
    </div>
    <div class="wechat-tip" id="wechatTip">
      <<i class="fa fa-info-circle mr-1"></</i> 微信用户请注意：若长时间未跳转，请点击右上角选择"在浏览器中打开"
    </div>
    <div class="expire-tip" id="expireTip">
      <<i class="fa fa-exclamation-circle mr-1"></</i> 该链接已过期，请联系链接提供者获取新链接
    </div>
  </div>

  <script>
    // 1. UA识别函数
    function getPlatform() {
      const ua = navigator.userAgent.toLowerCase();
      if (ua.includes('micromessenger')) {
        return 'wechat';
      } else if (ua.includes('qq/')) {
        return 'qq';
      } else if (ua.includes('alipay')) {
        return 'alipay';
      } else if (ua.includes('baidu')) {
        return 'baidu';
      } else {
        return 'other';
      }
    }

    // 2. 获取编码参数
    function getEncodedUrl() {
      const pathParts = window.location.pathname.split('/');
      return pathParts[pathParts.length - 1] || '';
    }

    // 3. 解码函数
    function base64Decode(str) {
      try {
        return decodeURIComponent(escape(atob(str)));
      } catch (e) {
        return '';
      }
    }

    // 4. 有效期验证函数
    function checkExpire(expireTime) {
      if (expireTime === '0') return true;
      const currentTime = Math.floor(Date.now() / 1000);
      const generateTime = currentTime - (parseInt(expireTime) - 300);
      return currentTime - generateTime <= parseInt(expireTime);
    }

    // 5. 主跳转函数
    function jump() {
      const encodedUrl = getEncodedUrl();
      if (!encodedUrl) {
        document.getElementById('loadTitle').textContent = '页面错误';
        document.getElementById('loadDesc').textContent = '缺少有效参数，无法加载资源';
        return;
      }

      try {
        const decodedStr = decodeURIComponent(encodedUrl);
        const base64Data = base64Decode(decodedStr);
        const [urlWithDelay, expireTime] = base64Data.split('#');
        const [targetUrl, customDelay] = urlWithDelay.split('|');
        
        if (!checkExpire(expireTime)) {
          document.getElementById('loadTitle').textContent = '链接已过期';
          document.getElementById('loadDesc').textContent = '该防红链接已超过有效期，无法使用';
          document.getElementById('expireTip').style.display = 'block';
          return;
        }

        if (/^https:\/\//i.test(targetUrl)) {
          const platform = getPlatform();
          let delay = parseInt(customDelay) || 800;

          if (platform === 'wechat') {
            delay = Math.max(delay, 1200);
            document.getElementById('wechatTip').style.display = 'block';
          } else if (platform === 'qq') {
            delay = Math.max(delay, 1000);
          }

          setTimeout(() => {
            window.location.href = targetUrl;
          }, delay);
        } else {
          document.getElementById('loadTitle').textContent = '链接无效';
          document.getElementById('loadDesc').textContent = '目标链接格式错误，请检查';
        }
      } catch (e) {
        document.getElementById('loadTitle').textContent = '解码失败';
        document.getElementById('loadDesc').textContent = '链接解析异常，请重新生成';
      }
    }

    // 6. 模拟进度条加载
    let progress = 0;
    const progressBar = document.getElementById('progress');
    const progressInterval = setInterval(() => {
      progress += 20;
      if (progress >= 100) {
        progress = 100;
        clearInterval(progressInterval);
        jump();
      }
      progressBar.style.width = progress + '%';
    }, 300);

    // 7. 平台适配文案
    window.onload = function() {
      const platform = getPlatform();
      if (platform === 'alipay') {
        document.getElementById('loadDesc').textContent = '支付宝正在安全验证，请稍候...';
      } else if (platform === 'baidu') {
        document.getElementById('loadDesc').textContent = '百度安全检测中，请稍候...';
      }
    };
  </script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
</body>
</html>
